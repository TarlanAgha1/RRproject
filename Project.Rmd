---
title: "Bank Marketing Data - A Decision Tree Approach"
authors: Tarlan Aghayev, Wojciech Misiura
date: "2024-05-03"
output:
  html_notebook: default
  html_document: default
---


Reference link to kaggle <https://www.kaggle.com/code/shirantha/bank-marketing-data-a-decision-tree-approach>

```{r}

```

## Context

As part of Reproducible Research course which is Mandatory course for 2nd year students of Data Science and Business Analytics, we are reproducing already existing project.

Link to the project: <https://www.kaggle.com/code/shirantha/bank-marketing-data-a-decision-tree-approach>

The aim of this attempt is to

```{r, message=FALSE, warning=FALSE, echo=FALSE}
#install.packages("remotes")
#library(remotes)

<<<<<<< HEAD
packages_version <- c(
  "readr" = "2.1.4", 
  "dplyr" = "1.1.2", 
  "ggplot2" = "3.4.2",
  "fastDummies" = "1.7.3",
  "rpart" = "4.1.23",
  "caret" = "6.0.94",
  "rpart.plot" = "3.1.2",
  "pROC" = "1.18.5",
  "corrplot" = "0.92",
  "RColorBrewer" = "1.1.3",
  "tibble" = "3.2.1"
)
=======
#packages_version <- c(
#  "readr" = "2.1.4", 
#  "dplyr" = "1.1.2", 
#  "ggplot2" = "3.4.2", 
#)
>>>>>>> dbe50508f6d28778d5c49fd003ce381ed04d74ed

#check_and_install <- function(package, version) {
#  if (!require(package, character.only = TRUE)) {
#    package_version_install <- paste0(package, "@", version)
#    remotes::install_version(package_version_install)
#  }
#}

<<<<<<< HEAD
mapply(check_and_install, names(packages_version), packages_version)
```
=======
#mapply(check_and_install, names(packages_version), packages_version)
>>>>>>> dbe50508f6d28778d5c49fd003ce381ed04d74ed

```{r}
url<-"https://raw.githubusercontent.com/WojciechMisiura/RRproject/main/bank.csv" 

bank<-read_csv(url)
```

```{r}
bank %>% summarize(across(everything(), ~sum(is.na(.))))

```

<<<<<<< HEAD
```{r}
summary(bank)
```


```{r}
ggplot(bank, aes(y = age)) + 
  geom_boxplot() + 
  theme_minimal() + 
  labs(title = "Boxplot for 'age'")
```

```{r}
ggplot(bank, aes(x = age)) +
  geom_histogram(bins = 100, fill = "blue", color = "black") +
  labs(title = "Distribution of Age") +
  theme_minimal()
```

```{r}
ggplot(bank, aes(y = duration)) + 
  geom_boxplot() + 
  theme_minimal() + 
  labs(title = "Boxplot for 'duration'")
```

```{r}
ggplot(bank, aes(x = duration)) +
  geom_histogram(bins = 100, fill = "blue", color = "black") +
  labs(title = "Distribution of Duration") +
  theme_minimal()
```

# Convert categorical variables

```{r}
bank_data <- bank
```

#### ------------------------------ job ------------------------------

```{r}
jobs <- c('management', 'blue-collar', 'technician', 'admin.', 'services', 
          'retired', 'self-employed', 'student', 'unemployed', 'entrepreneur', 
=======
## Loading Necessary Libraries

```{r setup, warning=FALSE, message=FALSE}
# install.packages('caret')
# install.packages('rpart.plot')

library(tidyverse)       
library(gridExtra)       
library(cluster)         
library(caret)           
library(rpart)           
library(rpart.plot)      
library(ModelMetrics) 
```

## Reading and Initial Analysis of Banking Dataset

```{r}
# reading file
file_path <- "C:/Users/PC/OneDrive/Desktop/falcony/RRproject2024/RRproject/bank.csv"

bank <- read.csv(file_path)

# initial analysis
head(bank)

sum(is.na(bank))

summary(bank)
```

## Explatory Data Analysis

```{r}
# Create a boxplot for 'age'
g_age <- ggplot(bank, aes(x = factor(0), y = age)) + 
  geom_boxplot() +
  labs(x = NULL, y = "Age") +
  theme(axis.title.x = element_blank())
g_age

# Create a distribution plot for 'age'
g_age_dist <- ggplot(bank, aes(x = age)) + 
  geom_histogram(bins = 100, fill = "blue", color = "black") +
  ggtitle("Distribution of Age")
g_age_dist

# Create a boxplot for 'duration'
g_duration <- ggplot(bank, aes(x = factor(0), y = duration)) + 
  geom_boxplot() +
  labs(x = NULL, y = "Duration") +
  theme(axis.title.x = element_blank())
g_duration

# Create a distribution plot for 'duration'
g_duration_dist <- ggplot(bank, aes(x = duration)) + 
  geom_histogram(bins = 100, fill = "red", color = "black") +
  ggtitle("Distribution of Duration")
g_duration_dist

```

## Convert Categorical Data

```{r}
# Copy data for processing
bank_data <- bank

# Count of people who made a deposit by job category
jobs <- c('management', 'blue-collar', 'technician', 'admin.', 'services',
          'retired', 'self-employed', 'student', 'unemployed', 'entrepreneur',
>>>>>>> dbe50508f6d28778d5c49fd003ce381ed04d74ed
          'housemaid', 'unknown')

for (j in jobs) {
  count <- sum(bank_data$deposit == "yes" & bank_data$job == j)
<<<<<<< HEAD
  cat(sprintf("%-15s : %5d\n", j, count))}
```

```{r}
table(bank_data$job)
```

```{r}
bank_data$job[bank_data$job %in% c('management', 'admin.')] <- 'white-collar'
bank_data$job[bank_data$job %in% c('services', 'housemaid')] <- 'pink-collar'
bank_data$job[bank_data$job %in% c('retired', 'student', 'unemployed', 'unknown')] <- 'other'

```

```{r}
table(bank_data$job)
```

#### ------------------------------ poutcome ------------------------------

```{r}
bank_data$poutcome <- as.character(bank_data$poutcome)
bank_data$poutcome[bank_data$poutcome == "other"] <- "unknown"
table(bank_data$poutcome)

```

#### ------------------------------ contact ------------------------------


```{r}
bank_data <- select(bank_data, -contact)
```

#### ------------------------------ default and housing and loan ------------------------------

```{r}
bank_data$default_cat <- as.integer(bank_data$default == "yes")
bank_data$housing_cat <- as.integer(bank_data$housing == "yes")
bank_data$loan_cat <- as.integer(bank_data$loan == "yes")

bank_data <- select(bank_data, -c(default, housing, loan))
```

#### ------------------------------ month, day ------------------------------

```{r}
bank_data <- select(bank_data, -c(month, day))
```

#### ------------------------------ deposit ------------------------------

```{r}
bank_data$deposit_cat <- as.integer(bank_data$deposit == "yes")
bank_data <- select(bank_data, -deposit)
```

#### ------------------------------ pdays ------------------------------

```{r}
cat("Customers that have not been contacted before:", sum(bank_data$pdays == -1), "\n")
cat("Maximum values on pdays:", max(bank_data$pdays), "\n")

bank_data$pdays[bank_data$pdays == -1] <- 10000

bank_data$recent_pdays <- ifelse(bank_data$pdays > 0, 1/bank_data$pdays, 1/bank_data$pdays)
bank_data <- select(bank_data, -pdays)
```

```{r}
tail(bank_data)
```

### ------------------------------ Convert to dummy values ------------------------------

```{r}
bank_with_dummies <- dummy_cols(bank_data, select_columns = c('job', 'marital', 'education', 'poutcome'),
                                remove_selected_columns = TRUE)
head(bank_with_dummies)
```

```{r}
print(dim(bank_with_dummies))

summary(bank_with_dummies)
```
### Observations on whole population

```{r}
ggplot(bank_with_dummies, aes(x = age, y = balance)) +
  geom_point(alpha = 0.5) +
  labs(title = "Scatterplot of Age vs. Balance",
       subtitle = "Across all ages, majority of people have savings of less than 20000",
       x = "Age", y = "Balance") +
  theme_minimal()
```

```{r}
ggplot(bank_with_dummies, aes(x = duration)) + 
  geom_histogram(data = subset(bank_with_dummies, poutcome_success == 1), fill = "blue", bins = 30) +
  labs(title = "Histogram of Duration for 'poutcome_success'",
       x = "Duration", y = "Count") +
  theme_minimal()
```

#### Analysis on people who sign up for a term deposite

```{r}
bank_with_dummies %>% 
  filter(deposit_cat == 1) %>%
  summary()
```

```{r}
sum(bank_with_dummies$deposit_cat == 1 & bank_with_dummies$loan_cat == 1 & bank_with_dummies$housing_cat == 1)
```

```{r}
sum(bank_with_dummies$deposit_cat == 1 & bank_with_dummies$default_cat == 1)
```

```{r}
ggplot(data = bank_data, aes(x = job, y = deposit_cat, fill = job)) +
  geom_bar(stat = "summary", fun = mean) +
  labs(title = "Average Deposit Category by Job", x = "Job Category", y = "Average Deposit Category") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  
```


```{r}
ggplot(data = bank_data, aes(x = poutcome, y = duration, fill = poutcome)) +
  geom_bar(stat = "summary", fun = mean) +
  labs(title = "Average Duration by Outcome", x = "Outcome", y = "Average Duration") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  
```

> ## Classification

```{r}
bankcl <- bank_with_dummies
```

```{r}
corr <- cor(bankcl, use = "complete.obs") 
print(corr)
```

```{r}
corrplot(corr, method = "color", type = "upper", order = "hclust",
         tl.col = "black", tl.srt = 45,
         col = colorRampPalette(c(brewer.pal(10, "RdBu")[10:1]))(200),
         title = "Heatmap of Correlation Matrix", 
         cl.lim = c(-0.3, 0.3))
```

```{r}
corr['deposit_cat']
typeof(corr)

corr_deposit <- as.data.frame(t(corr_row))
names(corr_deposit) <- "deposit_cat"  

corr_deposit$variable <- rownames(corr_deposit)
rownames(corr_deposit) <- NULL 

corr_deposit <- arrange(corr_deposit, desc(deposit_cat))
print(corr_deposit)
```

> ## Build the Data Model

```{r}
set.seed(50) 

label <- bankcl$deposit_cat
data_drop_deposit <- bankcl[, !names(bankcl) %in% 'deposit_cat']

index_train <- createDataPartition(label, p = 0.8, list = FALSE)
data_train <- data_drop_deposit[index_train, ]
label_train <- label[index_train]
data_test <- data_drop_deposit[-index_train, ]
label_test <- label[-index_train]
```

```{r}
train_and_evaluate <- function(depth) {
  model <- rpart(formula = deposit_cat ~ ., data = bankcl, method = "class",
                 control = rpart.control(maxdepth = depth, usesurrogate = 0, xval = 10))
  train_pred <- predict(model, data_train, type = "class")
  test_pred <- predict(model, data_test, type = "class")
  train_accuracy <- sum(train_pred == label_train) / length(label_train)
  test_accuracy <- sum(test_pred == label_test) / length(label_test)

  cat(sprintf("Depth %d: Training score: %f, Testing score: %f\n", depth, train_accuracy, test_accuracy))
}

for (depth in c(1, 2, 3, 4, 6)) {
  train_and_evaluate(depth)
}
```

#### Compare Training and Testing scores for various tree depths used

```{r}
scores <- list()
scores$`2` <- c(train = dt2_score_train, test = dt2_score_test)
scores$`3` <- c(train = dt3_score_train, test = dt3_score_test)
scores$`4` <- c(train = dt4_score_train, test = dt4_score_test)
scores$`6` <- c(train = dt6_score_train, test = dt6_score_test)
scores$max <- c(train = dt1_score_train, test = dt1_score_test)

cat(sprintf('%-10s %-20s %-20s\n', 'depth', 'Training score', 'Testing score'))
cat(sprintf('%-10s %-20s %-20s\n', '-----', '--------------', '-------------'))
for (depth in c("2", "3", "4", "6", "max")) {
    cat(sprintf('%-1s %-25.2f %-20.2f\n', depth, scores[[depth]]$train, scores[[depth]]$test))
}
```

```{r}
dt2 <- rpart(deposit_cat ~ ., data = bankcl, method = "class", control = rpart.control(maxdepth = 2))

rpart.plot(dt2, main = "Decision Tree for Depth 2", extra = 106)  
```

```{r}
features <- colnames(data_drop_deposite)
print(features)
```

```{r}
dt2 <- rpart(deposit_cat ~ ., data = bankcl, method = "class",
             control = rpart.control(maxdepth = 2, minsplit = 1, xval = 0, usesurrogate = 0))

fi <- as.data.frame(varImp(dt2, scale = FALSE))
names(fi) <- "Importance"
fi$Feature <- rownames(fi)
fi <- fi[order(-fi$Importance), ]
```

```{r}
cat(sprintf("%-20s %s\n", "Feature", "Importance"))
cat(sprintf("%-20s %s\n", "--------", "-----------"))
for (i in 1:nrow(fi)) {
  cat(sprintf("%-20s %.3f\n", fi$Feature[i], fi$Importance[i]))
}
```

## Predictions

```{r}
cat(sprintf("Mean duration   : %f\n", mean(data_drop_deposite$duration, na.rm = TRUE)))
cat(sprintf("Maximum duration: %d\n", max(data_drop_deposite$duration, na.rm = TRUE)))
cat(sprintf("Minimum duration: %d\n", min(data_drop_deposite$duration, na.rm = TRUE)))

```

```{r}
sample_data1 <- as.data.frame(t(matrix(c(0, 0, 371, rep(0, 22), 1), nrow = 26)))
colnames(sample_data1) <- features  

sample_data2 <- as.data.frame(t(matrix(c(0, 0, 3881, rep(0, 22), 1), nrow = 26)))
colnames(sample_data2) <- features

predict_proba1 <- predict(dt2, sample_data1, type = "prob")
predict_class1 <- predict(dt2, sample_data1, type = "class")

predict_proba2 <- predict(dt2, sample_data2, type = "prob")
predict_class2 <- predict(dt2, sample_data2, type = "class")

print(predict_proba1)
print(predict_class1)
print(predict_proba2)
print(predict_class2)
```

```{r}
print(data_drop_deposite[986, ])  # R indexing starts at 1
```

```{r}
preds <- predict(dt2, data_test, type = "class")

accuracy <- confusionMatrix(as.factor(preds), as.factor(label_test))
cat(sprintf("\nAccuracy score: \n%f\n", accuracy$overall['Accuracy']))

probs <- predict(dt2, data_test, type = "prob")[,2] 

auc <- roc(label_test, probs) 
cat(sprintf("\nArea Under Curve: \n%f\n", auc$auc))
```

```{r}

```

```{r}

```
=======
  cat(sprintf("%15s : %5d\n", j, count))
}

# Different types of job categories and their counts
table(bank_data$job)

# Similar jobs into categories
bank_data$job <- as.factor(bank_data$job)
levels(bank_data$job)[levels(bank_data$job) %in% c('management', 'admin.')] <- 'white-collar'
levels(bank_data$job)[levels(bank_data$job) %in% c('services', 'housemaid')] <- 'pink-collar'
levels(bank_data$job)[levels(bank_data$job) %in% c('retired', 'student', 'unemployed', 'unknown')] <- 'other'

# New value counts for job categories
table(bank_data$job)

```
>>>>>>> dbe50508f6d28778d5c49fd003ce381ed04d74ed
